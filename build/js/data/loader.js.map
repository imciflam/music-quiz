{"version":3,"file":"loader.js","sources":["js/data/loader.js"],"sourcesContent":["const URL = `https://es.dump.academy/guess-melody`;\nconst NAME_ID = `rusak178490`;\nconst CHUNK_SIZE = 4;\nlet AUDIO_LOAD_TIMEOUT = 5000; // 5 sec initial timeframe to load one chunk\n\nlet timeout;\nlet notLoadedUrls = [];\n\nexport default class Loader {\n  static getLevels() {\n    return fetch(`${URL}/questions`)\n      .then(response => {\n        if (response.ok) {\n          return response.json();\n        } else if (response.status === 404) {\n          throw new Error(`Данные по адресу ${URL}/questions не найдены.`);\n        }\n        throw new Error(\n          `Неизвестный статус: ${response.status} ${response.statusText}`\n        );\n      })\n      .then(data => {\n        return data;\n      });\n  }\n\n  static loadChunk(urls) {\n    return Promise.all(\n      urls.map(url => {\n        return new Promise((resolve, reject) => {\n          const audio = new Audio();\n          audio.addEventListener(`canplaythrough`, () => resolve(url), false);\n          audio.src = url;\n          timeout = setTimeout(() => reject(url), AUDIO_LOAD_TIMEOUT);\n        });\n      })\n    );\n  }\n\n  static loadBundle(bundles) {\n    let chain = Promise.resolve();\n\n    bundles.forEach(chunk => {\n      chain = chain\n        .then(() => {\n          clearTimeout(timeout);\n          return Loader.loadChunk(chunk);\n        })\n        .catch(url => {\n          notLoadedUrls.push(url);\n        });\n    });\n\n    return chain;\n  }\n\n  static createBundle(urls) {\n    return urls.reduce((acc, it, index) => {\n      const bundleIndex = parseInt(index / CHUNK_SIZE, 10);\n      if (typeof acc[bundleIndex] === `undefined`) {\n        acc[bundleIndex] = [];\n      }\n      acc[bundleIndex][index % CHUNK_SIZE] = it;\n      return acc;\n    }, []);\n  }\n\n  static cacheAudio(urls, cb) {\n    const bundle = Loader.createBundle(urls);\n    Loader.loadBundle(bundle).then(() => {\n      if (notLoadedUrls.length > 0) {\n        AUDIO_LOAD_TIMEOUT *= 2;\n        Loader.cacheAudio(notLoadedUrls, cb);\n        notLoadedUrls = [];\n      } else {\n        cb();\n      }\n    });\n  }\n\n  static getResults() {\n    return fetch(`${URL}/stats/${NAME_ID}`)\n      .then(response => {\n        if (response.ok) {\n          return response.json();\n        } else if (response.status === 404) {\n          return [];\n        }\n        throw new Error(\n          `Неизвестный статус: ${response.status} ${response.statusText}`\n        );\n      })\n      .then(data => {\n        let stats = [];\n        for (let it of data) {\n          if (it.stats) {\n            stats.push(it.stats);\n          }\n        }\n        return stats;\n      })\n      .catch(error => {\n        throw new Error(error);\n      });\n  }\n\n  static postResults(data) {\n    const requestSettings = {\n      body: JSON.stringify({\n        time: +new Date(),\n        stats: data\n      }),\n      headers: {\n        \"Content-Type\": `application/json`\n      },\n      method: `POST`\n    };\n    return fetch(`${URL}/stats/${NAME_ID}`, requestSettings);\n  }\n}\n"],"names":[],"mappings":"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"}